<div class="manage-rooms-container">
  <header class="page-header">
    <div class="header-text">
      <h1>Quản lý phòng trọ</h1>
      <p>Cập nhật thông tin, trạng thái và hình ảnh thực tế</p>
    </div>
    <button class="btn-primary" (click)="openAddModal()">+ Thêm phòng mới</button>
  </header>

  <main class="content-area">
    <div class="table-card" *ngIf="!isLoading">
      <table class="room-table">
        <thead>
          <tr>
            <th>Phòng & Tòa nhà</th>
            <th>Mô tả</th>
            <th>Diện tích</th>
            <th>Giá thuê</th>
            <th>Trạng thái</th>
            <th class="text-right">Thao tác</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let room of rooms; trackBy: trackByFn">
            <td>
              <div class="room-info">
                <span class="room-name">{{ room.name }}</span>
                <span class="building-name">{{ room.buildingName }}</span>
              </div>
            </td>
            <td>
              <div class="description-truncate" [title]="room.description">
                {{ room.description || 'Chưa có mô tả' }}
              </div>
            </td>
            <td><span class="badge-light">{{ room.area }} m²</span></td>
            <td><span class="price-text">{{ room.price | currency:'VND':'symbol':'1.0-0' }}</span></td>
            <td>
              <span class="status-pill" [ngClass]="room.status.toLowerCase()">
                {{ getStatusLabel(room.status) }}
              </span>
            </td>
            <td class="text-right">
              <div class="action-group">
                <button class="btn-link" (click)="openEditModal(room)">Sửa</button>
                <button class="btn-link danger" (click)="deleteRoom(room.id)">Xóa</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="isLoading" class="loading-state">Đang tải dữ liệu...</div>
  </main>

  <div class="modal-overlay" *ngIf="isModalOpen">
    <div class="modal-card">
      <div class="modal-header">
        <h2>{{ isEditMode ? 'Cập nhật phòng' : 'Thêm phòng mới' }}</h2>
        <button class="close-btn" (click)="isModalOpen = false">×</button>
      </div>
      
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label>Tòa nhà</label>
            <select [(ngModel)]="roomForm.buildingId" name="buildingId">
              <option *ngFor="let b of buildings" [value]="b.id">{{ b.name }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>Tên phòng</label>
            <input type="text" [(ngModel)]="roomForm.name" name="name" placeholder="P.101">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Giá thuê (VNĐ)</label>
            <input type="number" [(ngModel)]="roomForm.price" name="price">
          </div>
          <div class="form-group">
            <label>Diện tích (m²)</label>
            <input type="number" [(ngModel)]="roomForm.area" name="area">
          </div>
        </div>

        <div class="form-group">
          <div class="label-with-btn">
            <label>Tiện ích phòng</label>
            <button type="button" class="btn-add-inline" (click)="addNewAmenity()" title="Thêm tiện ích mới">+</button>
          </div>
          <div class="amenity-selection-grid">
            <div *ngFor="let a of allAmenities" 
                 class="amenity-tag" 
                 [class.active]="roomForm.amenityIds.includes(a.id!)"
                 (click)="toggleAmenity(a.id!)">
              {{ a.name }}
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Hình ảnh thực tế</label>
          <div class="upload-zone">
            <input type="file" (change)="onFileSelected($event)" multiple accept="image/*" id="fileIn" hidden>
            <label for="fileIn" class="upload-trigger">Chọn ảnh từ thiết bị</label>
            <div class="preview-row" *ngIf="imagePreviews.length > 0">
              <div class="preview-item" *ngFor="let img of imagePreviews; let i = index">
                <img [src]="img">
                <button class="remove-img" (click)="removeImage(i, true)">×</button>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Mô tả chi tiết</label>
          <textarea [(ngModel)]="roomForm.description" name="description" rows="3"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-ghost" (click)="isModalOpen = false">Hủy</button>
        <button class="btn-save" (click)="saveRoom()">Lưu thông tin</button>
      </div>
    </div>
  </div>
</div>